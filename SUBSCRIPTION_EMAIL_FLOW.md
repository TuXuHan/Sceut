# 📧 訂閱確認郵件完整流程圖

## 🔄 完整訂閱與郵件發送流程

\`\`\`
┌─────────────────────────────────────────────────────────────────────┐
│                      1. 用戶進入訂閱頁面                              │
│                    /app/subscribe/page.tsx                          │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   2. 填寫訂閱表單並提交                               │
│              components/periodicPaymentForm.tsx                     │
│                                                                     │
│  ├─ 商品描述：Sceut 香水訂閱                                          │
│  ├─ 每月金額：NT$ 599                                                │
│  └─ 付款週期：每月（共12期）                                           │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                3. 發起付款請求到 NeWebPay                             │
│                /api/newebpay/request/route.ts                       │
│                                                                     │
│  ├─ 生成商店訂單編號 (MerchantOrderNo)                                │
│  ├─ 生成付款表單                                                      │
│  └─ 重定向到 NeWebPay 付款頁面                                         │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    4. 用戶在 NeWebPay 完成付款                        │
│                      (第三方金流平台)                                 │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   5. NeWebPay 返回付款結果                            │
│                /api/newebpay/result/route.ts                        │
│                                                                     │
│  ├─ 解析付款結果                                                      │
│  ├─ 提取訂閱資訊 (PeriodNo, AuthTime, PeriodAmt)                      │
│  └─ 重定向到成功頁面                                                   │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    6. 顯示訂閱成功頁面                                │
│              /app/subscribe/success/page.tsx                        │
│                                                                     │
│  ├─ 顯示載入狀態                                                      │
│  └─ 調用創建訂閱 API                                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│           🎯 7. 創建訂閱記錄（郵件發送的觸發點）                        │
│              /api/subscriptions/create/route.ts                     │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────┐     │
│  │ 步驟 7.1: 接收並驗證訂閱資料                                │     │
│  │  ├─ userId, periodNo, authTime, periodAmt                │     │
│  │  ├─ selectedPerfume (香水資訊)                             │     │
│  │  └─ userProfile (用戶資料)                                 │     │
│  └───────────────────────────────────────────────────────────┘     │
│                             │                                       │
│                             ▼                                       │
│  ┌───────────────────────────────────────────────────────────┐     │
│  │ 步驟 7.2: 準備訂閱資料                                      │     │
│  │  ├─ subscription_status: "active"                         │     │
│  │  ├─ payment_status: "paid"                                │     │
│  │  ├─ monthly_fee: 599                                      │     │
│  │  ├─ last_payment_date: (當前時間)                          │     │
│  │  └─ next_payment_date: (下個月同一天)                       │     │
│  └───────────────────────────────────────────────────────────┘     │
│                             │                                       │
│                             ▼                                       │
│  ┌───────────────────────────────────────────────────────────┐     │
│  │ 步驟 7.3: 寫入資料庫                                         │     │
│  │  └─ Supabase: subscribers 表 (upsert)                     │     │
│  └───────────────────────────────────────────────────────────┘     │
│                             │                                       │
│                             ▼                                       │
│  ┌───────────────────────────────────────────────────────────┐     │
│  │ ✉️ 步驟 7.4: 發送訂閱確認郵件 ← 新增功能！                   │     │
│  │                                                           │     │
│  │  調用: sendSubscriptionConfirmationEmail({               │     │
│  │    to: data.email,                                       │     │
│  │    userName: data.name,                                  │     │
│  │    subscriptionId: data.id,                              │     │
│  │    periodNo: data.period_no,                             │     │
│  │    monthlyFee: data.monthly_fee,                         │     │
│  │    nextPaymentDate: data.next_payment_date,              │     │
│  │    perfumeName: selectedPerfume?.name,                   │     │
│  │    perfumeBrand: selectedPerfume?.brand,                 │     │
│  │  })                                                      │     │
│  │                                                           │     │
│  │  ├─ 使用 Resend API 發送郵件                              │     │
│  │  ├─ 包含訂閱詳情、香水資訊、後續步驟                         │     │
│  │  └─ 失敗不影響訂閱流程（記錄錯誤日誌）                       │     │
│  └───────────────────────────────────────────────────────────┘     │
│                             │                                       │
│                             ▼                                       │
│  ┌───────────────────────────────────────────────────────────┐     │
│  │ 步驟 7.5: 返回成功響應                                      │     │
│  │  └─ { success: true, subscription: data }                │     │
│  └───────────────────────────────────────────────────────────┘     │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      8. 用戶收到確認郵件 📬                           │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────┐      │
│  │  🎉 訂閱成功！                                             │      │
│  │  ─────────────────────────────────────────────────        │      │
│  │                                                           │      │
│  │  親愛的 XXX，您好！                                         │      │
│  │                                                           │      │
│  │  恭喜您成功訂閱 Sceut 香水服務！                             │      │
│  │                                                           │      │
│  │  📦 您選擇的香水                                            │      │
│  │  Chanel No.5                                             │      │
│  │  品牌：Chanel                                              │      │
│  │                                                           │      │
│  │  訂閱詳情                                                   │      │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━               │      │
│  │  訂閱編號：PER202501XXXXXX                                  │      │
│  │  月費：NT$ 599                                             │      │
│  │  下次扣款日期：2025年2月13日                                 │      │
│  │                                                           │      │
│  │  接下來會發生什麼？                                          │      │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━               │      │
│  │  1. 我們將為您精心包裝選中的香水                             │      │
│  │  2. 3-5 個工作天內送達您指定的地址                           │      │
│  │  3. 每月自動配送新香水到您手中                               │      │
│  │                                                           │      │
│  │          [查看我的訂閱] 按鈕                                 │      │
│  └──────────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│             9. 顯示訂閱成功頁面（前端確認）                            │
│                                                                     │
│  ├─ ✅ 訂閱狀態：已啟用                                               │
│  ├─ 💳 付款資訊：已完成                                               │
│  ├─ 📦 香水資訊：顯示選擇的香水                                        │
│  └─ 🔗 管理連結：會員中心、訂閱管理                                     │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│        10. NeWebPay 發送 Webhook（非同步，用於定期扣款通知）            │
│                /api/newebpay/callback/route.ts                      │
│                                                                     │
│  └─ 處理每月自動扣款的通知                                              │
└─────────────────────────────────────────────────────────────────────┘
\`\`\`

---

## 📧 郵件服務架構

\`\`\`
lib/email.ts
├─ sendSubscriptionConfirmationEmail()
│  ├─ 參數:
│  │  ├─ to: 用戶郵箱
│  │  ├─ userName: 用戶名稱
│  │  ├─ subscriptionId: 訂閱 ID
│  │  ├─ periodNo: 定期定額編號
│  │  ├─ monthlyFee: 月費金額
│  │  ├─ nextPaymentDate: 下次付款日期
│  │  ├─ perfumeName: 香水名稱（選填）
│  │  └─ perfumeBrand: 香水品牌（選填）
│  │
│  ├─ 郵件內容:
│  │  ├─ 美觀的 HTML 郵件模板
│  │  ├─ 漸層色標題 (#667eea → #764ba2)
│  │  ├─ 響應式設計（手機友善）
│  │  ├─ 訂閱詳情表格
│  │  ├─ 香水資訊卡片
│  │  ├─ 後續步驟說明（3個步驟）
│  │  └─ CTA 按鈕（前往會員中心）
│  │
│  └─ 使用 Resend API 發送
│     ├─ API Key: process.env.RESEND_API_KEY
│     ├─ From: process.env.EMAIL_FROM
│     └─ 錯誤處理: 不影響主流程
│
└─ sendSubscriptionCancellationEmail()
   └─ 用於訂閱取消時發送確認郵件
\`\`\`

---

## 🔐 環境變數配置

\`\`\`bash
# .env.local 文件
┌─────────────────────────────────────────────────┐
│ RESEND_API_KEY=re_xxxxx                        │ ← Resend API 金鑰（必填）
│ EMAIL_FROM=Sceut <noreply@yourdomain.com>      │ ← 寄件者郵箱
│ NEXT_PUBLIC_APP_URL=http://localhost:3000      │ ← 應用程式 URL
└─────────────────────────────────────────────────┘
\`\`\`

---

## 🧪 測試流程

### 方法 1: 使用測試 API

\`\`\`
瀏覽器訪問
    ↓
http://localhost:3000/api/test-email?email=your-email@example.com
    ↓
/app/api/test-email/route.ts
    ↓
調用 sendSubscriptionConfirmationEmail()
    ↓
發送測試郵件（包含測試資料）
    ↓
檢查郵箱 ✉️
\`\`\`

### 方法 2: 實際訂閱流程

\`\`\`
登入用戶
    ↓
前往 /subscribe
    ↓
完成訂閱表單
    ↓
NeWebPay 付款
    ↓
自動創建訂閱 + 發送郵件
    ↓
檢查郵箱 ✉️
\`\`\`

---

## ✅ 檢查清單

### 開發環境設定
- [ ] 已安裝 `resend` 套件（npm install resend）
- [ ] 已註冊 Resend 帳號
- [ ] 已獲取 Resend API 金鑰
- [ ] 已在 `.env.local` 設定 `RESEND_API_KEY`
- [ ] 已設定 `EMAIL_FROM`（可先使用測試郵箱）
- [ ] 已設定 `NEXT_PUBLIC_APP_URL`

### 測試
- [ ] 訪問測試 API 成功發送郵件
- [ ] 收到測試郵件（檢查垃圾郵件資料夾）
- [ ] 郵件顯示正確（電腦和手機）
- [ ] 郵件中的連結可點擊

### 生產環境準備
- [ ] 已驗證自定義域名（DNS 記錄）
- [ ] 已更新 `EMAIL_FROM` 為自定義域名郵箱
- [ ] 已在生產環境設定環境變數
- [ ] 已測試實際訂閱流程

---

## 🎨 郵件預覽

### 桌面版
\`\`\`
┌────────────────────────────────────────────────┐
│            🎉 訂閱成功！                         │
│      感謝您加入 Sceut 香水訂閱服務                │
│    (漸層紫色背景 #667eea → #764ba2)              │
├────────────────────────────────────────────────┤
│                                                │
│  親愛的 王小明，您好！                            │
│                                                │
│  恭喜您成功訂閱 Sceut 香水服務！                  │
│                                                │
│  ┌──────────────────────────────────────┐      │
│  │  您選擇的香水                           │      │
│  │  Chanel No.5                          │      │
│  │  品牌：Chanel                           │      │
│  └──────────────────────────────────────┘      │
│                                                │
│  訂閱詳情                                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━         │
│  訂閱編號      PER202501XXXXXX                  │
│  月費         NT$ 599                          │
│  下次扣款     2025年2月13日                      │
│                                                │
│  接下來會發生什麼？                               │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━         │
│  ① 我們將為您精心包裝選中的香水                   │
│  ② 3-5 個工作天內送達您指定的地址                 │
│  ③ 每月自動配送新香水到您手中                     │
│                                                │
│  ┌────────────────────────────┐               │
│  │                                            │
│  │    💡 訂閱管理提示                          │
│  │    您可以隨時在會員中心管理您的訂閱...        │
│  │                                            │
│  └────────────────────────────┘               │
│                                                │
│         [ 查看我的訂閱 ] 按鈕                    │
│                                                │
├────────────────────────────────────────────────┤
│  此郵件由系統自動發送，請勿直接回覆                 │
│  © 2025 Sceut. All rights reserved.           │
└────────────────────────────────────────────────┘
\`\`\`

---

## 📊 郵件發送監控

### Resend 控制台

登入 [resend.com](https://resend.com/) 可查看：
- 📈 發送統計
- ✉️ 郵件列表
- 📊 開信率
- 🔍 詳細日誌

### 伺服器日誌

\`\`\`bash
# 成功案例
📧 準備發送訂閱確認郵件到: user@example.com
✅ 訂閱確認郵件發送成功: { id: 'xxx-xxx-xxx' }

# 失敗案例（不影響訂閱）
📧 準備發送訂閱確認郵件到: user@example.com
⚠️ 訂閱確認郵件發送失敗，但不影響訂閱創建: Error: Invalid API key
\`\`\`

---

## 🚀 下一步

1. **立即測試**: 參考 [EMAIL_QUICK_START.md](./EMAIL_QUICK_START.md)
2. **詳細設定**: 參考 [EMAIL_SETUP_GUIDE.md](./EMAIL_SETUP_GUIDE.md)
3. **自定義郵件**: 編輯 `lib/email.ts`
4. **域名驗證**: 生產環境必須完成

---

**祝您使用愉快！** 🎉
